module.exports=[21306,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(40695),f=a.i(28624),g=a.i(24532),h=a.i(11913),i=a.i(46271),j=a.i(77577),k=a.i(15319),l=a.i(49666),m=a.i(92e3);let n=(0,a.i(70106).default)("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]);var o=a.i(46842),p=a.i(96221),q=a.i(44092),r=a.i(40385),s=a.i(89315),t=a.i(44735),u=a.i(71987);let v="leenk_customer_email";function w(){let a=(0,d.useParams)().phone,[w,x]=(0,c.useState)(null),[y,z]=(0,c.useState)(""),[A,B]=(0,c.useState)(""),[C,D]=(0,c.useState)(!0),[E,F]=(0,c.useState)(!1),[G,H]=(0,c.useState)(!1),[I,J]=(0,c.useState)(!0),[K,L]=(0,c.useState)(""),[M,N]=(0,c.useState)(!1),[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)(!1),S=(0,c.useRef)(null),T=(0,c.useRef)(null),U=(0,c.useRef)(null),{currentConversation:V,setCurrentConversation:W,loadConversation:X,addMessage:Y,updateConversation:Z}=(0,s.useConversationsStore)(),{connectionStatus:$,setupConversationChannel:_,broadcastTyping:aa}=(0,t.useRealtimeStore)();(0,c.useEffect)(()=>{let a=localStorage.getItem(v);a&&z(a)},[]),(0,c.useEffect)(()=>{y&&localStorage.setItem(v,y)},[y]),(0,c.useEffect)(()=>{(async()=>{let b=await j.storage.getBusinessByPhone(a);if(!b){L("Business not found"),J(!1);return}x(b),J(!1)})()},[a]);let ab=async a=>{if(w){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))return void L("Please enter a valid email address");L(""),H(!0);try{let b=await k.db.getConversationByBusinessAndEmail(w.id,a.trim());b?(b.customerName&&B(b.customerName),W(b),D(!1),F(!1)):F(!0)}catch(a){console.error("Error searching for conversation:",a),L("An error occurred. Please try again.")}finally{H(!1)}}},ac=async a=>{if(a&&a.preventDefault(),!w)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(y.trim()))return void L("Please enter a valid email address");if(!E&&!V)return void await ab(y);if(E&&!A.trim())return void L("Please provide your name");if(L(""),V){if(A.trim()&&V.customerName!==A.trim()){await j.storage.updateConversation(V.id,{customerName:A.trim()});let a=await j.storage.getConversationById(V.id);a&&W(a)}D(!1);return}let b={id:(0,l.v4)(),businessId:w.id,customerEmail:y.trim(),customerName:A.trim(),createdAt:new Date().toISOString(),lastMessageAt:new Date().toISOString(),messages:[]};try{await j.storage.createConversation(b);let a=await j.storage.getConversationById(b.id);a&&(W(a),D(!1),F(!1))}catch(a){console.error("Error creating conversation:",a),L("Failed to start chat. Please try again.")}};(0,c.useEffect)(()=>{if(V?.id)return _(V.id,"customer","customer",a=>{"business"===a&&(P(!0),U.current&&clearTimeout(U.current),U.current=setTimeout(()=>{P(!1)},3e3))})},[V?.id,_]);let ad=(0,c.useRef)(0);(0,c.useEffect)(()=>{if(!V?.id||"connected"===$){ad.current=V?.messages.length||0;return}let a=setInterval(async()=>{if(V.id)try{let{loadConversation:a}=s.useConversationsStore.getState(),b=await a(V.id);b&&b.messages.length>ad.current&&(ad.current=b.messages.length)}catch(a){console.error("Error polling for messages:",a)}},5e3);return()=>{clearInterval(a)}},[V?.id,$]),(0,c.useEffect)(()=>{S.current?.scrollIntoView({behavior:"smooth"})},[V?.messages]),(0,c.useEffect)(()=>{if(!V?.id||!w)return;let a=setTimeout(async()=>{try{await k.db.markMessagesAsRead(V.id,"business");let{loadConversation:a}=s.useConversationsStore.getState();await a(V.id)}catch(a){console.error("Error marking messages as read:",a)}},500);return()=>clearTimeout(a)},[V?.id,w?.id]),(0,c.useEffect)(()=>()=>{T.current&&clearTimeout(T.current),U.current&&clearTimeout(U.current)},[]);let ae=async a=>{if(!V||Q)return;R(!0);let b=(0,l.v4)(),c={id:b,conversationId:V.id,senderType:"customer",senderId:"customer",text:a,status:"sent",createdAt:new Date().toISOString()};Y(c),N(!1);try{await k.db.createMessage(c)}catch(c){console.error("Failed to send message:",c);let{removeMessage:a}=s.useConversationsStore.getState();a(b)}finally{R(!1)}},af=async a=>{if(!V||Q)return;R(!0);let b=(0,l.v4)(),c={id:b,conversationId:V.id,senderType:"customer",senderId:"customer",imageUrl:a,status:"sent",createdAt:new Date().toISOString()};Y(c),N(!1);try{await k.db.createMessage(c)}catch(c){console.error("Failed to send image:",c);let{removeMessage:a}=s.useConversationsStore.getState();a(b)}finally{R(!1)}};return I?null:K||!w?(0,b.jsx)("main",{className:"h-screen flex items-center justify-center bg-background p-4",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(m.AlertCircle,{className:"w-12 h-12 text-destructive mx-auto mb-4"}),(0,b.jsx)("h1",{className:"text-2xl font-bold mb-2",children:"Error"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:K})]})}):C?(0,b.jsx)("main",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 via-white to-slate-100 dark:from-slate-950 dark:via-slate-900 dark:to-slate-800 p-4",children:(0,b.jsx)(i.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},className:"w-full max-w-md",children:(0,b.jsxs)("div",{className:"bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-2xl overflow-hidden",children:[(0,b.jsxs)("div",{className:"bg-gradient-to-br from-primary/10 via-primary/5 to-transparent dark:from-primary/20 dark:via-primary/10 p-6 text-center border-b border-slate-200 dark:border-slate-800",children:[(0,b.jsx)(i.motion.div,{initial:{scale:.9},animate:{scale:1},transition:{delay:.1},className:"flex justify-center mb-4",children:(0,b.jsx)("div",{className:"relative",children:(0,b.jsx)(u.default,{src:"/logo.png",alt:"Leenk",width:80,height:80,className:"object-contain drop-shadow-lg"})})}),(0,b.jsx)(i.motion.h2,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"text-2xl font-bold text-slate-900 dark:text-white mb-3",children:w.businessName}),(0,b.jsxs)(i.motion.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"flex items-center justify-center gap-2",children:[(0,b.jsx)("div",{className:`w-2 h-2 rounded-full ${w.online?"bg-green-500 animate-pulse":"bg-red-500"}`}),(0,b.jsx)("span",{className:"text-sm font-medium text-slate-600 dark:text-slate-400",children:w.online?"Online":"Offline"})]})]}),(0,b.jsxs)("div",{className:"p-6 md:p-8",children:[(0,b.jsxs)("form",{onSubmit:ac,className:"space-y-5",children:[K&&(0,b.jsxs)(i.motion.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg text-red-700 dark:text-red-400 text-sm flex items-center gap-2",children:[(0,b.jsx)(m.AlertCircle,{className:"w-4 h-4 flex-shrink-0"}),(0,b.jsx)("span",{children:K})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)("label",{className:"block text-sm font-semibold text-slate-700 dark:text-slate-300",children:["Email Address ",(0,b.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(n,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 dark:text-slate-500"}),(0,b.jsx)("input",{type:"email",value:y,onChange:a=>{z(a.target.value),L("")},onBlur:a=>{a.target.value.trim()&&ab(a.target.value)},onKeyDown:a=>{"Enter"===a.key&&y.trim()&&!E&&(a.preventDefault(),ab(y))},placeholder:"your@email.com",className:"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 pl-11 py-3 text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all disabled:opacity-50 disabled:cursor-not-allowed",required:!0,disabled:G})]}),G&&(0,b.jsxs)("div",{className:"flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400",children:[(0,b.jsx)(p.Loader2,{className:"w-3 h-3 animate-spin"}),(0,b.jsx)("span",{children:"Searching for existing conversations..."})]})]}),E&&(0,b.jsxs)(i.motion.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.3},className:"space-y-2",children:[(0,b.jsxs)("label",{className:"block text-sm font-semibold text-slate-700 dark:text-slate-300",children:["Your Name ",(0,b.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(o.User,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 dark:text-slate-500"}),(0,b.jsx)("input",{type:"text",value:A,onChange:a=>{B(a.target.value),L("")},placeholder:"John Doe",className:"w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 pl-11 py-3 text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all",required:!0,autoFocus:!0})]})]}),(0,b.jsx)(e.Button,{type:"submit",className:"w-full h-12 text-base font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed",disabled:G||!y.trim()||E&&!A.trim(),children:G?(0,b.jsxs)("span",{className:"flex items-center gap-2",children:[(0,b.jsx)(p.Loader2,{className:"w-4 h-4 animate-spin"}),"Searching..."]}):(0,b.jsx)("span",{children:E?"Start Chat":"Continue"})})]}),(0,b.jsxs)("p",{className:"text-xs text-center text-slate-500 dark:text-slate-400 mt-6",children:["By continuing, you agree to start a conversation with ",w.businessName]})]})]})})}):V?(0,b.jsxs)("main",{className:"h-screen flex flex-col bg-[var(--chat-bg)] dark:bg-[var(--chat-bg)] relative",children:[(0,b.jsx)(q.Wallpaper,{}),(0,b.jsx)(i.motion.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"border-b border-border bg-card/80 backdrop-blur-sm p-3 md:p-4 relative z-10",children:(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)(r.Avatar,{src:w.businessLogo,name:w.businessName,size:"md"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"font-semibold text-lg text-foreground",children:w.businessName}),(0,b.jsxs)("p",{className:"text-xs text-muted-foreground",children:[w.online?"ðŸŸ¢ Online":"ðŸ”´ Offline","connected"===$&&(0,b.jsx)("span",{className:"ml-2 text-primary",title:"Real-time connected",children:"â—"}),"disconnected"===$&&(0,b.jsx)("span",{className:"ml-2 text-yellow-500",title:"Reconnecting...",children:"â—"})]})]})]})}),(0,b.jsxs)(i.motion.div,{initial:{opacity:0},animate:{opacity:1},className:"flex-1 overflow-y-auto p-3 md:p-4 space-y-2 relative z-0",children:[V&&0!==V.messages.length?(0,b.jsxs)(b.Fragment,{children:[V.messages.map((a,c)=>(0,b.jsx)(f.ChatBubble,{message:a,isOwn:"customer"===a.senderType,index:c},a.id)),O&&(0,b.jsx)(h.TypingIndicator,{isOwn:!1})]}):(0,b.jsx)("div",{className:"flex items-center justify-center h-full text-muted-foreground text-center",children:(0,b.jsxs)("p",{children:["Start a conversation with ",w.businessName]})}),(0,b.jsx)("div",{ref:S})]}),(0,b.jsx)("div",{className:"bg-card/80 backdrop-blur-sm border-t border-border relative z-10",children:(0,b.jsx)(g.MessageInput,{onSendMessage:ae,onSendImage:af,onTyping:()=>{N(!0),T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{N(!1)},3e3),V?.id&&aa(V.id,"customer")},disabled:Q||!V})})]}):(0,b.jsxs)("main",{className:"h-screen flex flex-col bg-[var(--chat-bg)] dark:bg-[var(--chat-bg)] relative",children:[(0,b.jsx)(q.Wallpaper,{}),(0,b.jsx)("div",{className:"relative z-10",children:(0,b.jsx)(i.motion.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"border-b border-border bg-card/80 backdrop-blur-sm p-3 md:p-4",children:(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)(r.Avatar,{src:w.businessLogo,name:w.businessName,size:"md"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h2",{className:"font-semibold text-lg text-foreground",children:w.businessName}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:w.online?"ðŸŸ¢ Online":"ðŸ”´ Offline"})]})]})})})]})}a.s(["default",()=>w],21306)}];

//# sourceMappingURL=app_chat_%5Bphone%5D_page_tsx_408113d2._.js.map