{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Desktop/leenk/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll()\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options)\n            )\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    }\n  )\n}\n\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 168, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Desktop/leenk/lib/email.ts"],"sourcesContent":["import nodemailer from \"nodemailer\"\n\n// Create transporter for Google SMTP\nexport function createEmailTransporter() {\n  return nodemailer.createTransport({\n    service: \"gmail\",\n    auth: {\n      user: process.env.SMTP_USER, // Your Gmail address\n      pass: process.env.SMTP_PASSWORD, // Your Gmail App Password\n    },\n  })\n}\n\n// Send email notification when business sends a message\nexport async function sendMessageNotificationEmail(\n  customerEmail: string,\n  customerName: string | undefined,\n  businessName: string,\n  messageText: string | undefined,\n  chatUrl: string\n): Promise<void> {\n  const transporter = createEmailTransporter()\n\n  const customerDisplayName = customerName || customerEmail.split(\"@\")[0]\n\n  const htmlContent = `\n    <!DOCTYPE html>\n    <html>\n      <head>\n        <meta charset=\"utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>New Message from ${businessName}</title>\n      </head>\n      <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0;\">\n          <h1 style=\"color: white; margin: 0; font-size: 24px;\">New Message from ${businessName}</h1>\n        </div>\n        \n        <div style=\"background: #ffffff; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;\">\n          <p style=\"font-size: 16px; margin-bottom: 20px;\">Hi ${customerDisplayName},</p>\n          \n          <p style=\"font-size: 16px; margin-bottom: 20px;\">\n            You have a new message from <strong>${businessName}</strong>:\n          </p>\n          \n          <div style=\"background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #667eea;\">\n            <p style=\"margin: 0; font-size: 16px; color: #333;\">\n              ${messageText || \"ðŸ“· [Image attachment]\"}\n            </p>\n          </div>\n          \n          <div style=\"text-align: center; margin: 30px 0;\">\n            <a href=\"${chatUrl}\" \n               style=\"display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n              Open Chat\n            </a>\n          </div>\n          \n          <p style=\"font-size: 14px; color: #666; margin-top: 30px; text-align: center;\">\n            Click the button above to view and reply to this message.\n          </p>\n        </div>\n        \n        <div style=\"text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;\">\n          <p style=\"font-size: 12px; color: #999; margin: 0;\">\n            This is an automated notification from Leenk. Please do not reply to this email.\n          </p>\n        </div>\n      </body>\n    </html>\n  `\n\n  const textContent = `\nNew Message from ${businessName}\n\nHi ${customerDisplayName},\n\nYou have a new message from ${businessName}:\n\n${messageText || \"[Image attachment]\"}\n\nOpen the chat to view and reply: ${chatUrl}\n\n---\nThis is an automated notification from Leenk. Please do not reply to this email.\n  `\n\n  await transporter.sendMail({\n    from: `\"${businessName}\" <${process.env.SMTP_USER}>`,\n    to: customerEmail,\n    subject: `New message from ${businessName}`,\n    text: textContent,\n    html: htmlContent,\n  })\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAGO,SAAS;IACd,OAAO,4JAAU,CAAC,eAAe,CAAC;QAChC,SAAS;QACT,MAAM;YACJ,MAAM,QAAQ,GAAG,CAAC,SAAS;YAC3B,MAAM,QAAQ,GAAG,CAAC,aAAa;QACjC;IACF;AACF;AAGO,eAAe,6BACpB,aAAqB,EACrB,YAAgC,EAChC,YAAoB,EACpB,WAA+B,EAC/B,OAAe;IAEf,MAAM,cAAc;IAEpB,MAAM,sBAAsB,gBAAgB,cAAc,KAAK,CAAC,IAAI,CAAC,EAAE;IAEvE,MAAM,cAAc,CAAC;;;;;;gCAMS,EAAE,aAAa;;;;iFAIkC,EAAE,aAAa;;;;8DAIlC,EAAE,oBAAoB;;;gDAGpC,EAAE,aAAa;;;;;cAKjD,EAAE,eAAe,wBAAwB;;;;;qBAKlC,EAAE,QAAQ;;;;;;;;;;;;;;;;;;EAkB7B,CAAC;IAED,MAAM,cAAc,CAAC;iBACN,EAAE,aAAa;;GAE7B,EAAE,oBAAoB;;4BAEG,EAAE,aAAa;;AAE3C,EAAE,eAAe,qBAAqB;;iCAEL,EAAE,QAAQ;;;;EAIzC,CAAC;IAED,MAAM,YAAY,QAAQ,CAAC;QACzB,MAAM,CAAC,CAAC,EAAE,aAAa,GAAG,EAAE,QAAQ,GAAG,CAAC,SAAS,CAAC,CAAC,CAAC;QACpD,IAAI;QACJ,SAAS,CAAC,iBAAiB,EAAE,cAAc;QAC3C,MAAM;QACN,MAAM;IACR;AACF"}},
    {"offset": {"line": 266, "column": 0}, "map": {"version":3,"sources":["file:///Users/mac/Desktop/leenk/app/api/broadcast/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { createClient } from \"@/lib/supabase/server\"\nimport { sendMessageNotificationEmail } from \"@/lib/email\"\nimport { v4 as uuidv4 } from \"uuid\"\n\nexport async function POST(request: NextRequest) {\n  try {\n    const supabase = await createClient()\n    \n    // Verify user is authenticated\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    // Get user's business\n    const { data: business, error: businessError } = await supabase\n      .from(\"businesses\")\n      .select(\"*\")\n      .eq(\"email\", user.email)\n      .single()\n\n    if (businessError || !business) {\n      return NextResponse.json({ error: \"Business not found\" }, { status: 404 })\n    }\n\n    const body = await request.json()\n    const { message } = body\n\n    if (!message || !message.trim()) {\n      return NextResponse.json({ error: \"Message is required\" }, { status: 400 })\n    }\n\n    // Get all conversations for this business\n    const { data: conversations, error: conversationsError } = await supabase\n      .from(\"conversations\")\n      .select(\"*\")\n      .eq(\"business_id\", business.id)\n\n    if (conversationsError) {\n      console.error(\"Error fetching conversations:\", conversationsError)\n      return NextResponse.json({ error: \"Failed to fetch conversations\" }, { status: 500 })\n    }\n\n    if (!conversations || conversations.length === 0) {\n      return NextResponse.json({ \n        error: \"No conversations found\", \n        sentCount: 0,\n        totalCount: 0 \n      }, { status: 400 })\n    }\n\n    // Create messages for all conversations\n    const messagePromises = conversations.map(async (conversation) => {\n      const messageId = uuidv4()\n      const dbData = {\n        id: messageId,\n        conversation_id: conversation.id,\n        sender_type: \"business\",\n        sender_id: business.id,\n        content: message.trim(),\n        image_url: null,\n        status: \"sent\",\n        reply_to_id: null,\n      }\n\n      try {\n        // Insert message\n        const { data: createdMessage, error: msgError } = await supabase\n          .from(\"messages\")\n          .insert(dbData)\n          .select()\n          .single()\n\n        if (msgError) {\n          console.error(`Error creating message for conversation ${conversation.id}:`, msgError)\n          return { success: false, conversationId: conversation.id, error: msgError.message }\n        }\n\n        // Update conversation's updated_at\n        await supabase\n          .from(\"conversations\")\n          .update({ updated_at: new Date().toISOString() })\n          .eq(\"id\", conversation.id)\n\n        // Send email notification (fire and forget - don't block on email failures)\n        if (conversation.customer_email) {\n          try {\n            const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || request.headers.get(\"origin\") || \"http://localhost:3000\"\n            const chatUrl = `${baseUrl}/chat/${business.phone}`\n\n            await sendMessageNotificationEmail(\n              conversation.customer_email,\n              conversation.customer_name || undefined,\n              business.business_name || \"Business\",\n              message.trim(),\n              chatUrl\n            )\n          } catch (emailError) {\n            console.error(`Failed to send email to ${conversation.customer_email}:`, emailError)\n            // Don't fail the broadcast if email fails\n          }\n        }\n\n        return { success: true, conversationId: conversation.id, messageId }\n      } catch (error: any) {\n        console.error(`Error processing conversation ${conversation.id}:`, error)\n        return { success: false, conversationId: conversation.id, error: error.message }\n      }\n    })\n\n    // Wait for all messages to be created\n    const results = await Promise.all(messagePromises)\n    \n    const successCount = results.filter(r => r.success).length\n    const failureCount = results.filter(r => !r.success).length\n\n    return NextResponse.json({\n      success: true,\n      sentCount: successCount,\n      totalCount: conversations.length,\n      failures: failureCount,\n      message: `Broadcast sent to ${successCount} out of ${conversations.length} conversations`\n    })\n\n  } catch (error: any) {\n    console.error(\"Error sending broadcast:\", error)\n    return NextResponse.json(\n      { error: error.message || \"Failed to send broadcast\" },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,+BAA+B;QAC/B,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QACxE,IAAI,aAAa,CAAC,MAAM;YACtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,sBAAsB;QACtB,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,SACpD,IAAI,CAAC,cACL,MAAM,CAAC,KACP,EAAE,CAAC,SAAS,KAAK,KAAK,EACtB,MAAM;QAET,IAAI,iBAAiB,CAAC,UAAU;YAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,GAAG;QAEpB,IAAI,CAAC,WAAW,CAAC,QAAQ,IAAI,IAAI;YAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAsB,GAAG;gBAAE,QAAQ;YAAI;QAC3E;QAEA,0CAA0C;QAC1C,MAAM,EAAE,MAAM,aAAa,EAAE,OAAO,kBAAkB,EAAE,GAAG,MAAM,SAC9D,IAAI,CAAC,iBACL,MAAM,CAAC,KACP,EAAE,CAAC,eAAe,SAAS,EAAE;QAEhC,IAAI,oBAAoB;YACtB,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgC,GAAG;gBAAE,QAAQ;YAAI;QACrF;QAEA,IAAI,CAAC,iBAAiB,cAAc,MAAM,KAAK,GAAG;YAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,WAAW;gBACX,YAAY;YACd,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,wCAAwC;QACxC,MAAM,kBAAkB,cAAc,GAAG,CAAC,OAAO;YAC/C,MAAM,YAAY,IAAA,mLAAM;YACxB,MAAM,SAAS;gBACb,IAAI;gBACJ,iBAAiB,aAAa,EAAE;gBAChC,aAAa;gBACb,WAAW,SAAS,EAAE;gBACtB,SAAS,QAAQ,IAAI;gBACrB,WAAW;gBACX,QAAQ;gBACR,aAAa;YACf;YAEA,IAAI;gBACF,iBAAiB;gBACjB,MAAM,EAAE,MAAM,cAAc,EAAE,OAAO,QAAQ,EAAE,GAAG,MAAM,SACrD,IAAI,CAAC,YACL,MAAM,CAAC,QACP,MAAM,GACN,MAAM;gBAET,IAAI,UAAU;oBACZ,QAAQ,KAAK,CAAC,CAAC,wCAAwC,EAAE,aAAa,EAAE,CAAC,CAAC,CAAC,EAAE;oBAC7E,OAAO;wBAAE,SAAS;wBAAO,gBAAgB,aAAa,EAAE;wBAAE,OAAO,SAAS,OAAO;oBAAC;gBACpF;gBAEA,mCAAmC;gBACnC,MAAM,SACH,IAAI,CAAC,iBACL,MAAM,CAAC;oBAAE,YAAY,IAAI,OAAO,WAAW;gBAAG,GAC9C,EAAE,CAAC,MAAM,aAAa,EAAE;gBAE3B,4EAA4E;gBAC5E,IAAI,aAAa,cAAc,EAAE;oBAC/B,IAAI;wBACF,MAAM,UAAU,QAAQ,GAAG,CAAC,oBAAoB,IAAI,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;wBACrF,MAAM,UAAU,GAAG,QAAQ,MAAM,EAAE,SAAS,KAAK,EAAE;wBAEnD,MAAM,IAAA,8IAA4B,EAChC,aAAa,cAAc,EAC3B,aAAa,aAAa,IAAI,WAC9B,SAAS,aAAa,IAAI,YAC1B,QAAQ,IAAI,IACZ;oBAEJ,EAAE,OAAO,YAAY;wBACnB,QAAQ,KAAK,CAAC,CAAC,wBAAwB,EAAE,aAAa,cAAc,CAAC,CAAC,CAAC,EAAE;oBACzE,0CAA0C;oBAC5C;gBACF;gBAEA,OAAO;oBAAE,SAAS;oBAAM,gBAAgB,aAAa,EAAE;oBAAE;gBAAU;YACrE,EAAE,OAAO,OAAY;gBACnB,QAAQ,KAAK,CAAC,CAAC,8BAA8B,EAAE,aAAa,EAAE,CAAC,CAAC,CAAC,EAAE;gBACnE,OAAO;oBAAE,SAAS;oBAAO,gBAAgB,aAAa,EAAE;oBAAE,OAAO,MAAM,OAAO;gBAAC;YACjF;QACF;QAEA,sCAAsC;QACtC,MAAM,UAAU,MAAM,QAAQ,GAAG,CAAC;QAElC,MAAM,eAAe,QAAQ,MAAM,CAAC,CAAA,IAAK,EAAE,OAAO,EAAE,MAAM;QAC1D,MAAM,eAAe,QAAQ,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,OAAO,EAAE,MAAM;QAE3D,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,WAAW;YACX,YAAY,cAAc,MAAM;YAChC,UAAU;YACV,SAAS,CAAC,kBAAkB,EAAE,aAAa,QAAQ,EAAE,cAAc,MAAM,CAAC,cAAc,CAAC;QAC3F;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,MAAM,OAAO,IAAI;QAA2B,GACrD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}